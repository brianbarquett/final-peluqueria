<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sacar Turnos</title>
    <style>
        body {
            background-color: #000000;
            color: #FFD700;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 70%;
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }
        h1 {
            text-align: center;
            color: #FFD700;
        }
        .days {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .day-button {
            background-color: #333333;
            color: #FFD700;
            border: 1px solid #FFD700;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .day-button:hover {
            background-color: #FFD700;
            color: #000000;
        }
        .day-button.selected {
            background-color: #FFD700;
            color: #000000;
        }
        .schedules {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #333333;
            padding: 10px;
            border-radius: 5px;
        }
        .status-green {
            color: green;
        }
        .status-red {
            color: red;
        }
        .agendar-button {
            background-color: #FFD700;
            color: #000000;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: opacity 0.3s;
        }
        .agendar-button:hover {
            opacity: 0.8;
        }
        #modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1a1a1a;
            padding: 20px;
            border: 1px solid #FFD700;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
            z-index: 1000;
            width: 300px;
        }
        #modal select, #modal button {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #333333;
            color: #FFD700;
            border: 1px solid #FFD700;
            border-radius: 5px;
        }
        #modal button {
            background-color: #FFD700;
            color: #000000;
            cursor: pointer;
        }
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sacar Turno</h1>
        <div class="days" id="days"></div>
        <div class="schedules" id="schedules"></div>
    </div>

    <div id="overlay"></div>
    <div id="modal">
        <select id="category-select">
            <option value="">Selecciona un servicio</option>
        </select>
        <select id="service-select" disabled>
            <option value="">Selecciona un sub-servicio</option>
        </select>
        <button id="confirm-button">Confirmar</button>
    </div>

    <script>
        // Horarios
        const morningHours = ['08:00', '09:00', '10:00', '11:00', '12:00'];
        const eveningHours = ['17:00', '18:00', '19:00', '20:00', '21:00'];
        const hours = [...morningHours, ...eveningHours];

        // Generar días de lunes a sábado a partir de la fecha actual
        const daysOfWeek = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
        const currentDate = new Date('2025-10-14');
        const currentDay = currentDate.getDay(); // 0=Dom, 1=Lun, ..., 6=Sab

        // Encontrar el próximo lunes
        let daysToMonday = (1 - currentDay + 7) % 7;
        if (daysToMonday === 0 && currentDay !== 1) daysToMonday = 7;
        const mondayDate = new Date(currentDate);
        mondayDate.setDate(currentDate.getDate() + daysToMonday);

        const dayButtons = [];
        for (let i = 0; i < 6; i++) {
            const dayDate = new Date(mondayDate);
            dayDate.setDate(mondayDate.getDate() + i);
            const dayName = daysOfWeek[i];
            const formattedDate = dayDate.toISOString().split('T')[0];
            const button = document.createElement('button');
            button.classList.add('day-button');
            button.textContent = `${dayName} ${dayDate.getDate()}/${dayDate.getMonth() + 1}`;
            button.dataset.date = formattedDate;
            button.addEventListener('click', () => selectDay(button, formattedDate));
            dayButtons.push(button);
        }

        const daysContainer = document.getElementById('days');
        dayButtons.forEach(btn => daysContainer.appendChild(btn));

        let selectedDate = null;

        async function selectDay(button, date) {
            dayButtons.forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedDate = date;
            await loadSchedules(date);
        }

        async function loadSchedules(date) {
            const schedulesContainer = document.getElementById('schedules');
            schedulesContainer.innerHTML = '';
            const takenTimes = await fetchTakenTimes(date);
            hours.forEach(hour => {
                const isReserved = takenTimes.includes(`${hour}:00`);
                const item = document.createElement('div');
                item.classList.add('schedule-item');
                const timeSpan = document.createElement('span');
                timeSpan.textContent = `${hour} `;
                const statusSpan = document.createElement('span');
                statusSpan.textContent = isReserved ? 'Reservado' : 'Reservar';
                statusSpan.classList.add(isReserved ? 'status-red' : 'status-green');
                const button = document.createElement('button');
                button.textContent = 'Agendar';
                button.classList.add('agendar-button');
                button.disabled = isReserved;
                button.addEventListener('click', () => openModal(date, `${hour}:00`));
                item.appendChild(timeSpan);
                item.appendChild(statusSpan);
                item.appendChild(button);
                schedulesContainer.appendChild(item);
            });
        }

        async function fetchTakenTimes(date) {
            const response = await fetch(`get_schedules.php?date=${date}`);
            const data = await response.json();
            return data;
        }

        // Modal
        const modal = document.getElementById('modal');
        const overlay = document.getElementById('overlay');
        const categorySelect = document.getElementById('category-select');
        const serviceSelect = document.getElementById('service-select');
        const confirmButton = document.getElementById('confirm-button');

        // Cargar categorías al abrir modal
        async function loadCategories() {
            const response = await fetch('get_categories.php');
            const categories = await response.json();
            categorySelect.innerHTML = '<option value="">Selecciona un servicio</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.titulo;  // Usamos titulo como value, ya que table name se deriva de él
                option.textContent = cat.titulo;
                categorySelect.appendChild(option);
            });
        }

        categorySelect.addEventListener('change', async (e) => {
            const category = e.target.value;
            serviceSelect.innerHTML = '<option value="">Selecciona un sub-servicio</option>';
            serviceSelect.disabled = !category;
            if (category) {
                const response = await fetch(`get_services.php?category=${encodeURIComponent(category)}`);
                const services = await response.json();
                services.forEach(srv => {
                    const option = document.createElement('option');
                    option.value = srv.id;
                    option.textContent = srv.titulo;
                    serviceSelect.appendChild(option);
                });
            }
        });

        let currentDateTime = null;

        function openModal(date, time) {
            currentDateTime = { date, time };
            categorySelect.value = '';
            serviceSelect.value = '';
            serviceSelect.disabled = true;
            loadCategories();  // Cargar categorías dinámicamente
            modal.style.display = 'block';
            overlay.style.display = 'block';
        }

        function closeModal() {
            modal.style.display = 'none';
            overlay.style.display = 'none';
        }

        confirmButton.addEventListener('click', async () => {
            const category = categorySelect.value;
            const serviceId = serviceSelect.value;
            if (category && serviceId) {
                const success = await bookAppointment(currentDateTime.date, currentDateTime.time, category, serviceId);
                if (success) {
                    closeModal();
                    await loadSchedules(selectedDate);
                } else {
                    alert('Error al agendar el turno.');
                }
            } else {
                alert('Por favor, selecciona un servicio y sub-servicio.');
            }
        });

        async function bookAppointment(date, time, category, serviceId) {
            const response = await fetch('book_appointment.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, time, category, service_id: serviceId })
            });
            const data = await response.json();
            return data.success;
        }

        overlay.addEventListener('click', closeModal);

        // Seleccionar el primer día por defecto
        if (dayButtons.length > 0) {
            selectDay(dayButtons[0], dayButtons[0].dataset.date);
        }
    </script>
</body>
</html>